# Check for NULLs
cat("Checking for NULL/empty values...\n", sep="")
for (df_name in df_names) {
df <- get(df_name)
num_nulls <- sum(is.na(df))
if(num_nulls) {
cat(df_name,": ",num_nulls," NULLs","\n",sep="")
}
# Check for empty strings (which do not show up as NULLs)
empty_strings <- df %>%
filter(if_any(where(is.character), ~ nchar(.) == 0))
num_empty_strings = nrow(empty_strings)
if(num_empty_strings) {
cat(df_name,": ",num_empty_strings," empty strings","\n",sep="")
}
}
cat("Checking for NULL/empty values done.\n", sep="")
rm(df, df_name, num_nulls, empty_strings, num_empty_strings, df_name)
# Chunk 10: update_variable_names
# Function Declarations ----
rename_df_variables <- function(df_name, var_mods) {
cat("Renaming variables in \"",df_name,"\"...\n", sep = "")
df <- get(df_name)
# Check each var name requiring correction against the var names in the df
for (i in 1:nrow(var_mods)) {
var_old = var_mods$var_old[i]
if (!(var_old %in% colnames(df))) {
next
}
# If found, make sure the conversion is applicable to this or all dfs
tbl <- var_mods$tbl[i]
if (tbl != "" && tbl != df_name) {
next
}
# Perform the conversion if all checks passed
var_new = var_mods$var_new[i]
cat("df: ",df_name, "\tvar_old: ",var_old,"\t",sep="")
cat("var_new: ",var_new,"\t", sep="")
cat("tbl: ",tbl,"    ", sep="")
cat("Replacing... ", sep = "")
df <- df %>% rename(!!var_new := !!var_old)
cat("Done.\n", sep = "")
}
rm(i)
cat("Renaming variables in \"",df_name,"\" complete.\n", sep = "")
return(df)
}
# Global Variable Declarations ----
var_mods <- data.frame(
var_old = character(0),
var_new  = character(0),
type_new = character(0),
tbl = character(0)
)
# WARNING: Ensure table-specific modifications (tbl != "") are positioned above non-specific modifications with matching var_old/var_new values: only the first modification in the list will be applied to matching variables.
# TODO: Eliminate this issue by modifying code to warn/handle conflicting rows
var_mods <- var_mods %>%
rbind(.,data.frame(var_old="date",                       var_new="bodycomp_datetime",          type_new="POSIXct", tbl="bodycomp_src_logs_wide")) %>%
rbind(.,data.frame(var_old="time",                       var_new="heart_rate_second",          type_new="POSIXct", tbl="heartrate_src_seconds_tall")) %>%
rbind(.,data.frame(var_old="value",                      var_new="heart_rate",                 type_new="",        tbl="heartrate_src_seconds_tall")) %>%
rbind(.,data.frame(var_old="date",                       var_new="sleep_minute",               type_new="POSIXct", tbl="sleep_src_mins_tall")) %>%
rbind(.,data.frame(var_old="value",                      var_new="sleep_rank",                 type_new="",        tbl="sleep_src_mins_tall")) %>%
rbind(.,data.frame(var_old="",                           var_new="activity_hour",              type_new="POSIXct", tbl="")) %>%
rbind(.,data.frame(var_old="",                           var_new="activity_minute",            type_new="POSIXct", tbl="")) %>%
rbind(.,data.frame(var_old="",                           var_new="sleep_day",                  type_new="POSIXct", tbl="")) %>%
rbind(.,data.frame(var_old="",                           var_new="id",                         type_new="character", tbl="")) %>%
rbind(.,data.frame(var_old="log_id",                     var_new="sleep_log_id",               type_new="character", tbl="sleep_src_mins_tall")) %>%
rbind(.,data.frame(var_old="log_id",                     var_new="bodycomp_log_id",            type_new="character", tbl="bodycomp_src_logs_wide")) %>%
rbind(.,data.frame(var_old="activity_date",              var_new="activity_day",               type_new="Date",   tbl="")) %>%
rbind(.,data.frame(var_old="fairly_active_distance",     var_new="distance_fairly_active",     type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="fairly_active_minutes",      var_new="minutes_fairly_active",      type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="light_active_distance",      var_new="distance_lightly_active",    type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="light_active_minutes",       var_new="minutes_lightly_active",     type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="lightly_active_distance",    var_new="distance_lightly_active",    type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="lightly_active_minutes",     var_new="minutes_lightly_active",     type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="logged_activities_distance", var_new="distance_logged_activities", type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="me_ts",                      var_new="mets",                       type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="moderately_active_distance", var_new="distance_moderately_active", type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="sedentary_active_distance",  var_new="distance_sedentary",         type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="sedentary_distance",         var_new="distance_sedentary",         type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="sedentary_active_minutes",   var_new="minutes_sedentary",          type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="sedentary_minutes",          var_new="minutes_sedentary",          type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="step_total",                 var_new="steps_total",                type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="total_distance",             var_new="distance_total",             type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="total_intensity",            var_new="intensity_total",            type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="total_minutes_asleep",       var_new="minutes_asleep_total",       type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="total_sleep_records",        var_new="sleep_records_total",        type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="total_steps",                var_new="steps_total",                type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="total_time_in_bed",          var_new="minutes_in_bed_total",       type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="tracker_distance",           var_new="distance_tracker",           type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="very_active_distance",       var_new="distance_very_active",       type_new="",        tbl="")) %>%
rbind(.,data.frame(var_old="very_active_minutes",        var_new="minutes_very_active",        type_new="",        tbl=""))
## Rename Variables ----
cat("Cleaning variable names...\n", sep = "")
for(df_name in df_names) {
cat("Cleaning ",df_name,"...\n", sep = "")
assign(df_name, get(df_name) %>% clean_names())
}
cat("Cleaning variable names complete.\n", sep = "")
cat("Renaming variables...\n", sep = "")
var_mods_rename <- var_mods %>%
filter(var_old != "" & var_new != "")
for(df_name in df_names) {
assign(df_name, rename_df_variables(df_name, var_mods_rename))
}
rm(df_name)
cat("Renaming variables complete.\n", sep = "")
# Chunk 11: remove_duplicates
cat("Checking for duplicate values...\n",sep="")
for (df_name in df_names) {
cat("Checking ",df_name," for duplicates... ",sep="")
df <- get(df_name)
if (!anyDuplicated(df)) {
cat("0 duplicates removed. Done.\n",sep="")
} else {
nrow_before <- nrow(df)
df <- distinct(df)
nrow_after <- nrow(df)
cat("Removing ",(nrow_before - nrow_after)," duplicates... ",sep="")
assign(df_name, df)
cat("Done.\n",sep="")
}
}
rm(df, df_name, nrow_before, nrow_after)
cat("Checking for duplicate values complete.\n",sep="")
# Chunk 12: update_variable_types_nonfactors
# Global Variable Declarations ----
var_mods_recast <- var_mods %>%
filter(type_new != "")
# Function Declarations ----
are_identical_lists <- function(list1, list2) {
if (length(list1) != length(list2)) {
return(FALSE)
}
for (i in seq_along(list1)) {
if(!identical(list1[[i]], list2[[i]])) {
cat("Non-identical lists at list1[",i,"]. Exiting.\n", sep = "")
print(list1[[i]])
print(list2[[i]])
rm(i)
return(FALSE)
}
}
rm(i)
return(TRUE)
}
get_df_var_types <- function(df_name) {
cat("Getting current variable types for ", df_name, "... ", sep = "")
df <- get(df_name)
var_types <- data.frame(
var = names(df),
type = sapply(df, function(col) class(col)[1])
)
cat("Done.\n", sep = "")
return(var_types)
}
get_df_target_var_types <- function(df_name) {
cat("Getting target variable types for ", df_name, "...\n", sep = "")
var_types <- get_df_var_types(df_name)
# Iterate over rows in current var_types
for (var_row in 1:nrow(var_types)) {
# Check if var name is in var_mods_recast
var_name <- var_types$var[var_row]
for(mods_row in 1:nrow(var_mods_recast)) {
var_name_mods <- var_mods_recast$var_new[mods_row]
# If no, skip: if yes, replace type with target
if(var_name == var_name_mods) {
type_new <- var_mods_recast$type_new[mods_row]
cat("Updated \"", var_name, "\" from ", var_types$type[var_row], " to ", var_mods_recast$type_new[mods_row], ".\n", sep = "")
var_types$type[var_row] <- type_new
}
}
}
cat("Getting target variable types for ", df_name, " done.\n", sep = "")
return(var_types)
}
recast_variables <- function(df_name) {
df <- get(df_name)
for (i in 1:nrow(var_mods_recast)) {
var_new <- var_mods_recast$var_new[i]
type_new <- var_mods_recast$type_new[i]
if (var_new %in% colnames(df)) {
cat("Converting ",df_name,"$",var_new," to ",type_new, "... ", sep = "")
if (type_new == "character") {
df <- df %>% mutate("{var_new}" := as.character(!!sym(var_new)))
} else if (type_new == "Date") {
df <- df %>% mutate("{var_new}" := mdy(!!sym(var_new)))
} else if (type_new == "POSIXct") {
df <- df %>% mutate("{var_new}" := mdy_hms(!!sym(var_new)))
} else {
cat("type_new not found: not converting.", sep = "")
}
cat("Done.\n", sep = "")
}
}
rm(i)
return(df)
}
# Recast Variables ----
cat("Generating list of target column types for testing...\n", sep = "")
df_types_target <-lapply(df_names, get_df_target_var_types)
names(df_types_target) <- df_names
cat("Generating list of target column types complete.\n", sep = "")
cat("Recasting variables...\n", sep = "")
for (df_name in df_names) {
cat("Recasting ",df_name,"...\n", sep = "")
assign(df_name, recast_variables(df_name))
cat("Converting ",df_name," complete.\n", sep = "")
}
cat("Recasting variables complete.\n", sep = "")
# Test Recasting of Variables ----
cat("Generating list of updated column types...\n", sep = "")
df_types_after <- lapply(df_names, get_df_var_types)
names(df_types_after) <- df_names
cat("Generating list of updated column types complete.\n", sep = "")
cat("Checking updated column types against target types...\n", sep = "")
test_succeeded <- are_identical_lists(df_types_after, df_types_target)
cat("Checking updated column types against target types complete.\n", sep = "")
cat("Data recasting ", case_when(test_succeeded ~ "succeeded", TRUE ~"failed"), ".", sep = "")
rm(df_name, df_types_target, df_types_after, test_succeeded)
# Chunk 13: update_variable_types_factors
# Individual recast of variables with only one occurrence
sleep_src_mins_tall <- sleep_src_mins_tall %>%
mutate(sleep_rank = factor(sleep_rank, levels = 1:3, labels = c("Asleep", "Restless", "Awake")))
intensity_src_mins_tall <- intensity_src_mins_tall %>%
mutate(intensity = factor(intensity, levels = 0:3, labels = c("Sedentary", "Lightly Active", "Fairly Active", "Very Active")))
# Chunk 14: trim_whitespace_variables
cat("Trimming whitespace in variable names...\n", sep="")
for (df_name in df_names) {
df <- get(df_name)
for (col_name in colnames(df)) {
col_name_trimmed <- str_trim(col_name)
cat("Trimming ",df_name, "[",col_name,"] to ",col_name_trimmed,"... ",sep="")
df <- df %>% rename(!!col_name := !!col_name_trimmed)
cat("Done.\n", sep = "")
}
}
rm(df, df_name, col_name, col_name_trimmed)
cat("Trimming whitespace in variable names complete.\n", sep="")
# Chunk 15: trim_whitespace_data
trim_chr_column <- function(col) {
if (is.character(col)) {
return(str_trim(col))
} else {
return(col)
}
}
cat("Trimming whitespace in character-type data values...\n", sep="")
for (df_name in df_names) {
df <- get(df_name)
for (col_name in colnames(df)) {
if (is.character(df[[col_name]])) {
cat("Trimming ",df_name, "[",col_name,"]... ",sep="")
# df <- df %>% mutate(if_any(where(is.character), trim_chr_column))
df <- df %>% mutate(across(all_of(col_name), str_trim))
cat("Done.\n", sep = "")
}
}
}
rm(df, df_name, col_name)
cat("Trimming whitespace in character-type data values complete.\n", sep="")
# Chunk 16: validate_ID_lengths
validate_string_length <- function(df_name, col_name, valid_length) {
cat("Checking ",df_name," for invalid ",col_name," values... ",sep="")
df <- get(df_name)
if (col_name %in% colnames(df)) {
invalid_values <- df %>% select(!!sym(col_name)) %>% filter(nchar(!!sym(col_name)) != valid_length)
}
if (exists('invalid_values') && nrow(invalid_values) > 0) {
cat(nrow(invalid_values)," invalid values found:\n",sep="")
glimpse(invalid_values)
rm(invalid_values)
} else {
cat("complete.\n",sep="")
}
rm(df)
}
result <- map(df_names, ~validate_string_length(.x, col_name = "id", valid_length = 10))
result <- map(df_names, ~validate_string_length(.x, col_name = "sleep_log_id", valid_length = 11))
result <- map(df_names, ~validate_string_length(.x, col_name = "bodycomp_log_id", valid_length = 13))
rm(result)
# Chunk 17: validate_ID_ranges
cat("Checking min/max ID value ranges...\n",sep="")
id_col_names <- c("id", "sleep_log_id", "bodycomp_log_id")
for (df_name in df_names) {
df <- get(df_name)
for (col_name in id_col_names) {
if(col_name %in% colnames(df)) {
cat(df_name,"[",col_name,"] Min = ",min(df[[col_name]])," Max = ",max(df[[col_name]]),".\n",sep="")
}
}
}
rm(df, df_name, col_name, id_col_names)
cat("Checking min/max ID value ranges complete.\n",sep="")
# Chunk 18: validate_all_dates
validate_dates <- function(df_name) {
valid_dates_stt <- as.Date("2016-03-12", format = "%Y-%m-%d")
valid_dates_end <- as.Date("2016-05-14", format = "%Y-%m-%d")
cat("Validating dates for ",df_name,"... ",sep="")
date_columns <- get(df_name) %>%
select_if(function(col) is.POSIXct(col) || is.Date(col))
if (ncol(date_columns) == 0) {
cat("Error: no date column found.\n",sep="")
} else if (ncol(date_columns) > 1) {
cat("Error: more than one date column found for ",df_name,".\n",sep="")
} else {
outside_range <- date_columns %>%
filter(if_any(everything(), ~ . < valid_dates_stt | . > valid_dates_end))
if (nrow(outside_range) > 0) {
cat("found ",nrow(outside_range)," invalid values:\n",sep="")
print(outside_range)
rm(outside_range)
} else {
cat("complete.\n")
}
}
rm(date_columns)
}
result <- lapply(df_names, validate_dates)
rm(result)
# Chunk 19: validate_all_numeric
validate_numerics <- function(df_name) {
# This function performs all checks on numeric values that are required in more than one data-frame, e.g. non-negativity and summation
cat("Validating numerics for ",df_name,"... ",sep="")
numerics <- get(df_name) %>% select_if(is.numeric)
if (ncol(numerics) == 0) {
cat("No numeric variables found.\n",sep="")
} else {
# Check for negative values
negative_values <- numerics %>%
filter(if_any(everything(), ~ . < 0))
if (nrow(negative_values) > 0) {
cat("found ",nrow(negative_values)," invalid values:\n",sep="")
print(negative_values)
} else {
cat("complete.\n")
}
rm(negative_values)
# Check for summation
}
rm(numerics)
}
result <- lapply(df_names, validate_numerics)
rm(result)
# Chunk 20: validate_specific_numeric
# For a given list of dfs, column names, and a min-max range, check all matching columns in all matching dfs against that range
validate_within_range <- function(df_name, column_names, range_min, range_max) {
df <- get(df_name)
for (col_name in column_names) {
cat("Checking ranges for ",df_name,"[",col_name,"]... ",sep="")
if (!(col_name %in% colnames(df))) {
cat("column not found.\n")
} else {
out_of_range <- df %>%
filter(!!sym(col_name) < range_min | !!sym(col_name) > range_max)
if (nrow(out_of_range) <= 0) {
cat("complete.\n",sep="")
} else {
cat("Found ",nrow(out_of_range)," out-of-range values:\n",sep="")
glimpse(out_of_range)
}
rm(out_of_range)
}
}
rm(df, col_name)
}
# Minute summation
valid_df_names <- c(
"activity_sum_days_wide",
"intensity_sum_days_wide",
"sleep_sum_days_wide")
valid_col_names <- c(
"minutes_very_active",
"minutes_fairly_active",
"minutes_lightly_active",
"minutes_sedentary",
"minutes_asleep_total",
"minutes_in_bed_total")
range_max <- 60 * 12 # Minutes in half a day
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
# Weights (kg)
valid_df_names <- c("bodycomp_src_logs_wide")
valid_col_names <- c("weight_kg")
range_max <- 150 # Arbitrarily chosen as high enough to be a potentially erroneous value
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
# Weights (pounds, same limit as for weight in kilos)
valid_df_names <- c("bodycomp_src_logs_wide")
valid_col_names <- c("weight_pounds")
kg2lb <- 2.204623
range_max <- 150 * kg2lb # Arbitrarily chosen as high enough to be a potentially erroneous value
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
rm(kg2lb)
# BMI
valid_df_names <- c("bodycomp_src_logs_wide")
valid_col_names <- c("bmi")
range_max <- 40.0 # Corresponds with the WHO "Obese (Class III)" weight category
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
# Distances
valid_df_names <- c(
"activity_sum_days_wide",
"intensity_sum_days_wide")
valid_col_names <- c(
"distance_lightly_active",
"distance_logged_activities",
"distance_moderately_active",
"distance_sedentary",
"distance_total",
"distance_tracker",
"distance_very_active")
range_max <- 21.08241 # Equivalent to one half-marathon
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
# Step counts
valid_df_names <- c(
"activity_sum_days_wide",
"steps_sum_days_tall",
"steps_sum_hours_tall",
"steps_src_mins_tall")
valid_col_names <- c(
"steps",
"steps_total")
range_max <- 14800 # Set to double the average daily step count for Australian adults
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
# Calories
valid_df_names <- c(
"activity_sum_days_wide",
"calories_src_mins_tall",
"calories_sum_days_tall",
"calories_sum_hours_tall")
valid_col_names <- c("calories")
range_max <- 4000 # Chosen arbitrarily as double the typically-recommended daily caloric intake
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
# TODO: METs
valid_df_names <- c("mets_src_mins_tall")
valid_col_names <- c("mets")
range_max <- 12 # Equivalent to vigourous squash playing
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
# Heart Rates
valid_df_names <- c("heartrate_src_seconds_tall")
valid_col_names <- c("heart_rate")
range_max  <- 200 # Chosen based on average 100% heart-rate for a 20 y.o. (Source: American Heart Foundation)
result <- map(valid_df_names, ~validate_within_range(.x, valid_col_names, 0, range_max))
rm(range_max, result, valid_df_names, valid_col_names)
debugSource("~/Documents/GitHub/Bellabeat Case Study/Bellabeat_BGJ.R")
debugSource("~/Documents/GitHub/Bellabeat Case Study/Bellabeat_BGJ.R")
overhang_rhs <- max(0, as.double(difftime(zGap_range_stt, zSleep_range_stt, units = "hours")))
debugSource("~/Documents/GitHub/Bellabeat Case Study/Bellabeat_BGJ.R")
# Skip all gaps that start after the sleep range
zGap_range_stt = id_gaps$heart_rate_second[j]
debugSource("~/Documents/GitHub/Bellabeat Case Study/Bellabeat_BGJ.R")
debugSource("~/Documents/GitHub/Bellabeat Case Study/Bellabeat_BGJ.R")
days2secs <- 60*60*24
sleep_ranges_stt = seq(as.POSIXct("2016-04-12 20:00:00", tz = "UTC"),
as.POSIXct("2016-05-12 20:00:00", tz = "UTC"),
by=days2secs)
sleep_ranges_end = seq(as.POSIXct("2016-04-13 06:00:00", tz = "UTC"),
as.POSIXct("2016-05-13 06:00:00", tz = "UTC"),
by=days2secs)
sleep_ranges <- tibble(stt = sleep_ranges_stt,
end = sleep_ranges_end)
hr_data_gaps <- heartrate_src_seconds_tall %>%
group_by(id) %>%
nest() %>%
mutate(next_poll = map(data, ~ lead(.x$heart_rate_second))) %>%
mutate(gap = map(data, ~ difftime(lead(.x$heart_rate_second), .x$heart_rate_second, units = "hours"))) %>%
unnest(cols = c(data, next_poll, gap)) %>%
filter(gap >= 3600)
get_date_range_overlap <- function(date1_stt, date1_end, date2_stt, date2_end) {
# Returns a percentage indicating the amount that date2 range overlaps date1 range
if (zGap_range_stt >= zSleep_range_end | zGap_range_end <= zSleep_range_stt) {
overlap <- 0
} else {
duration <- as.double(difftime(date1_end, date1_stt, units = "hours"))
overlap = min(1, max(0,
duration
- max(0, as.double(difftime(date2_stt, date1_stt)))
- max(0, as.double(difftime(date1_end, date2_end)))
) / duration)
}
return(overlap)
}
for (hr_id in unique(hr_data_gaps$id)) {
id_gaps <- hr_data_gaps %>% filter(id == hr_id)
for (i in 1:nrow(sleep_ranges)) {
zSleep_range_stt <- sleep_ranges$stt[i]
zSleep_range_end <- sleep_ranges$end[i]
duration <- as.double(difftime(zSleep_range_end, zSleep_range_stt))
polling_coverage <- 1.0
# How much does the gap overlap the target region?
for (j in 1:nrow(id_gaps)) {
# Stop checking gaps if range is already completely covered
if (polling_coverage <= 0) {
break
}
# Ignore gaps that end before the sleep range
zGap_range_end = id_gaps$next_poll[j]
if (zGap_range_end <= zSleep_range_stt) {
next
}
# Skip all gaps that start after the sleep range
zGap_range_stt = id_gaps$heart_rate_second[j]
if (zGap_range_stt >= zSleep_range_end) {
break
}
overhang_lhs <- max(0, as.double(difftime(zGap_range_stt, zSleep_range_stt, units = "hours")))
overhang_rhs <- max(0, as.double(difftime(zSleep_range_end, zGap_range_end, units = "hours")))
overlap = min(1, max(0, duration - overhang_lhs - overhang_rhs) / duration)
polling_coverage <- max(0, polling_coverage - overlap)
cat("update polling_coverage:", polling_coverage,"\n")
}
cat("final polling_coverage:", polling_coverage,"\n")
}
}
