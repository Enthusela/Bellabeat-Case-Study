geom_bar(stat = "identity") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
labs(title="Average Time by Intensity Zone",
x = "User ID",
y = "Total Average Daily Time (minutes)")
# Chunk 30: calories_vs_activity
mean_non_sedentary_time <- intensity_sum_days_wide %>%
group_by(id, activity_day) %>%
summarize("non_sedentary_time" = sum(minutes_lightly_active,
minutes_fairly_active,
minutes_very_active)) %>%
group_by(id) %>%
summarize("mean_non_sedentary_time" = mean(non_sedentary_time))
cals_vs_activity <- merge(mean_daily_cals, mean_non_sedentary_time, by="id")
plot_cal_vs_non_sedentary <- ggplot(cals_vs_activity) +
geom_point(aes(x=mean_non_sedentary_time, y=mean_calories)) +
geom_smooth(mapping=aes(x=mean_non_sedentary_time,y=mean_calories),
method = "lm",
se = FALSE,
color = "blue") +
stat_cor(aes(x=mean_non_sedentary_time, y=mean_calories, label=..rr.label..),
label.x=0,
label.y=0)
# Chunk 31: cals_vs_more_active
mean_fairly_active_time <- intensity_sum_days_wide %>%
group_by(id, activity_day) %>%
summarize("active_time" = sum(minutes_fairly_active,
minutes_very_active)) %>%
group_by(id) %>%
summarize("mean_fairly_active_time" = mean(active_time))
cals_vs_activity <- merge(mean_daily_cals, mean_fairly_active_time, by="id")
plot_cal_vs_active <- ggplot(cals_vs_activity) +
geom_point(aes(x=mean_fairly_active_time, y=mean_calories)) +
geom_smooth(mapping=aes(x=mean_fairly_active_time,y=mean_calories),
method = "lm",
se = FALSE,
color = "blue") +
stat_cor(aes(x=mean_fairly_active_time, y=mean_calories, label=..rr.label..),
label.x=0,
label.y=0)
# Chunk 32: cals_vs_very_active
mean_very_active_time <- intensity_sum_days_wide %>%
group_by(id) %>%
summarize("mean_active_time" = mean(minutes_very_active))
cals_vs_very_active <- merge(mean_daily_cals, mean_very_active_time, by="id")
plot_cal_vs_very_active <- ggplot(cals_vs_very_active, aes(x=mean_active_time, y=mean_calories)) +
geom_point() +
geom_smooth(mapping=aes(x=mean_active_time,y=mean_calories), method = "lm", se = FALSE, color = "blue") +
stat_cor(aes(x=mean_active_time, y=mean_calories, label=..rr.label..), label.x=0, label.y=0)
# Chunk 33: plot_cals_vs_intensity
plot_cal_vs_non_sedentary <- plot_cal_vs_non_sedentary + scale_x_continuous(limits=c(0,350))
plot_cal_vs_active <- plot_cal_vs_active + scale_x_continuous(limits=c(0,350))
plot_cal_vs_very_active <- plot_cal_vs_very_active + scale_x_continuous(limits=c(0,350))
grid.arrange(plot_cal_vs_non_sedentary, plot_cal_vs_active, plot_cal_vs_very_active, nrow = 3)
# Chunk 41: util_functions
round_data_to_bin <- function(data, bin_width) {
rounding_factor <- 1 / bin_width
return(round(data * rounding_factor) / rounding_factor)
}
get_histogram_max_count <- function(data, bin_width) {
rounding_factor <- 1 / bin_width
# Round data to nearest multiple of bin_width
data_rounded <- round_data_to_bin(data, bin_width)
max_count <- max(table(data_rounded))
return(max_count)
}
rescale_plot <- function(p, x_min = 0, x_max = 10, x_step = 1, y_min = 0, y_max = 10, y_step = 1) {
p <- p +
scale_x_continuous(breaks = seq(x_min, x_max, by=x_step),
labels = scales::comma_format(),
limits=c(x_min, x_max)) +
scale_y_continuous(breaks = seq(y_min, y_max, by=y_step),
labels = scales::comma_format(),
limits=c(y_min, y_max))
return(p)
}
# Chunk 42: plot_histo_pareto
plot_histo_pareto <- function (data, bin_width) {
# Cumulative data uses same bins as histogram
data <- sort(data)
data_rounded <- round_data_to_bin(data, bin_width)
# Calculate highest count so axes can be adjusted
highest_count <- get_histogram_max_count(data, bin_width)
data_pareto <- seq(1, length(data), by = 1) / length(data) * highest_count
# Calculate stats for overlay on histogram
data_max <- max(data)
data_mean <- round(mean(data), digits = 2)
data_median <- round(median(data), digits = 2)
sum_stats <- data.frame(Statistics = c("Mean", "Median"),
value = c(data_mean, data_median))
label_text <- paste("Mean =", data_mean, "\nMedian =", data_median)
p <- ggplot() +
geom_histogram(aes(x = data),
color = "white",
binwidth = bin_width) +
geom_line(aes(x = data_rounded,
y = data_pareto),
color="forestgreen") +
geom_vline(data = sum_stats,
aes(xintercept = value,
linetype = Statistics,
color = Statistics),
size = 1) +
scale_x_continuous(breaks = seq(0, data_max + bin_width, by = bin_width)) +
scale_y_continuous(name = "Count",
breaks = seq(0, highest_count, by = 1),
sec.axis = sec_axis(~./highest_count, name = "Cumulative Percentage of Count")) +
annotate("text", x = Inf, y = Inf, label = label_text,
hjust = 1, vjust = 1, size = 4) +
labs(x = "Value")
return(p)
}
# Chunk 43: plot_time_coefficients
get_time_coefficients <- function(ids, timestamps, values) {
tbl <- tibble(
id = ids,
timestamp = timestamps,
value = values
)
coeffs <- tbl %>%
mutate(day_of_year = yday(timestamp)) %>%
group_by(id) %>%
summarize(correlation = cor(day_of_year, value))
return(coeffs)
}
plot_time_coefficients <- function(coeffs) {
bin_width <- 0.1
max_count <- get_histogram_max_count(coeffs$correlation, bin_width)
ggplot(coeffs, aes(x = correlation)) +
geom_histogram(binwidth = bin_width, color = "white") +
scale_x_continuous(breaks = seq(-1.0, 1.0, by=bin_width)) +
scale_y_continuous(breaks = seq(0, max_count, by=1)) +
labs(title = "Correlations with Time",
caption = "Positive values imply variable of interest generally increased over time.",
x = "Coefficient of Correlation",
y = "Count")
}
get_time_coefficients_plot <- function(ids, timestamps, values) {
coeffs <- get_time_coefficients(ids, timestamps, values)
p <- plot_time_coefficients(coeffs)
return(p)
}
# Chunk 44: plot_wide_data_to_stacked_bar
wide_to_stacked_bar_plot <- function(data_wide, key, value, key_order) {
if(!("id" %in% colnames(data_wide))) {
print("ERROR: data does not include \"id\" column: cannot convert.")
} else {
# Convert the data from wide to long. Set the factor levels to control the stacking order of the bars
data_long <- data_wide %>%
tidyr::gather(key = !!sym(key), value = !!sym(value), -id) %>%
mutate(!!sym(key) := factor(!!sym(key), levels = key_order))
# Order IDs in wide data based on value of first key, then rearrange long data.
# This ensures the resultant plot sorts the IDs in ascending order of the first key
first_key <- key_order[1]
data_wide <- data_wide %>% arrange(!!sym(first_key))
data_long$id <- factor(
data_long$id,
levels = data_wide$id)
# Plot graph with angled ID labels
p <- ggplot(data_long, aes(x= id, y= !!sym(value), fill= !!sym(key))) +
geom_bar(stat = "identity") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
# scale_y_continuous(breaks = seq(0, 24, by = 1))
}
}
# Chunk 45: plot_scatter_with_LOBF
scatter_with_LOBF <- function(data_x, data_y, labels = NULL) {
data <- tibble(
x = data_x,
y = data_y
)
p <- ggplot(data,
aes(x = x, y = y)) +
geom_point() +
geom_smooth(method = "lm",
se = FALSE,
color = "blue") +
stat_cor(mapping=aes(label=..rr.label..),
method="pearson",
label.x=-Inf,
label.y=Inf,
hjust = -0.1,
vjust = 1.1) +
geom_text(aes(label = sprintf("Gradient: %.2f", coef(lm(y ~ x, data = data))[2])),
x = -Inf,
y= Inf,
hjust = -0.05,
vjust = 3.5)
if(!is.null(labels) && length(labels > 1)) {
p <- p + labs(title = paste(labels[1], "vs.", labels[2]),
x = labels[1],
y = labels[2])
}
return(p)
}
# Chunk 46: viz_average_daily_intensities_by_id
# For each ID, generate averages for the three non-sedentary intensity levels
mean_daily_intensities_wide <- intensity_sum_days_wide %>%
group_by(id) %>%
summarize("sedentary" = mean(minutes_sedentary) / 60,
"lightly_active" = mean(minutes_lightly_active) / 60,
"fairly_active" = mean(minutes_fairly_active) / 60,
"very_active" = mean(minutes_very_active) / 60)
#Convert data to long-format for plotting as a histogram
intensity_order = c("sedentary", "lightly_active", "fairly_active", "very_active")
mean_daily_intensities_long <- mean_daily_intensities_wide %>%
tidyr::gather(key = "intensity", value = "mean_hours", -id) %>%
mutate(intensity = factor(intensity, levels = intensity_order))
# Reorder IDs in order of "Very Active" time
mean_daily_intensities_wide <- mean_daily_intensities_wide %>%
mutate("total_active" = lightly_active + fairly_active + very_active) %>%
arrange(total_active)
# Apply order of IDs to long-format data to force plot order
mean_daily_intensities_long$id <- factor(
mean_daily_intensities_long$id,
levels = mean_daily_intensities_wide$id)
ggplot(mean_daily_intensities_long, aes(x= id, y= mean_hours, fill= intensity)) +
geom_bar(stat = "identity") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
scale_y_continuous(breaks = seq(0, 24, by = 1)) +
labs(title="Average Time by Intensity Zone",
x = "User ID",
y = "Total Average Daily Time (hours)")
# Chunk 47: viz_active_hours_by_count
# Update total_active to reflect new definition
mean_daily_intensities_wide <- mean_daily_intensities_wide %>%
mutate(total_active = fairly_active + very_active) %>%
arrange(total_active)
mean_active_hours <- mean_daily_intensities_wide %>%
select(id, total_active)
# Add cumulative user count for Pareto analysis
total_users <- nrow(mean_active_hours)
bin_width <- 0.25
rounding_factor <- 1 / bin_width
mean_active_hours <- mean_active_hours %>%
mutate(total_active_rounded = round(total_active * rounding_factor) / rounding_factor) %>%
mutate(cumulative_users = row_number() / total_users)
mean_hours <- mean(mean_active_hours$total_active)
median_hours <- median(mean_active_hours$total_active)
ymax <- 12
xmax <- 13.5
ggplot(mean_active_hours, aes(x=total_active)) +
geom_histogram(binwidth = bin_width, col="white") +
scale_x_continuous(breaks = seq(0, xmax, by = bin_width)) +
geom_line(aes(x = total_active_rounded,
y = cumulative_users * ymax),
col="red") +
geom_vline(aes(xintercept = mean_hours, col = 'red')) +
geom_vline(aes(xintercept = median_hours), col = 'blue') +
scale_y_continuous(name = "Number of Users",
breaks = seq(0, ymax, by = 1),
sec.axis = sec_axis(~./ymax,name = "Cumulative Percentage of Users")) +
labs(title = "Active Hours per Week",
x = "Hours")
# Chunk 48: viz_proportion_intensity
# For each ID, generate proportion Very Active time
mean_daily_intensities_wide <- mean_daily_intensities_wide %>%
mutate(proportion_very_active = very_active / total_active)
# Convert data to long-format for plotting as a histogram
intensity_order = c("fairly_active", "very_active")
mean_daily_intensities_long <- mean_daily_intensities_wide %>%
tidyr::gather(key = "intensity", value = "mean_hours", -id) %>%
mutate(intensity = factor(intensity, levels = intensity_order)) %>%
filter(intensity == "fairly_active" | intensity == "very_active")
# Reorder IDs in order of "Very Active" time
mean_daily_intensities_wide <- mean_daily_intensities_wide %>%
arrange(proportion_very_active)
# Apply order of IDs to long-format data to force plot order
mean_daily_intensities_long$id <- factor(
mean_daily_intensities_long$id,
levels = mean_daily_intensities_wide$id)
ggplot(mean_daily_intensities_long, aes(x= id, y= mean_hours, fill= intensity)) +
geom_bar(stat = "identity",
position = "fill") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
labs(title="Proportion of Average Time by Intensity Zone",
x = "User ID",
y = "Average Daily Time (%)")
# Chunk 49: viz_logged_minutes_vs_intensity
plot_all_data <- ggplot(mean_daily_intensities_wide, aes(x=total_active, y=proportion_very_active)) +
geom_point() +
geom_smooth(method = "lm",
se = FALSE,
color = "blue") +
stat_cor(aes(label=..rr.label..),
label.x=0,
label.y=0) +
labs(title="Proportion Very Active vs. Total Active Time",
x = "Average Weekly Active Time (hours)",
y = "Proportion of Very Active Time (%)")
data <- mean_daily_intensities_wide %>%
filter(total_active <= 1.25) # id != "3977333714")
plot_no_upper_quint <- ggplot(data, aes(x=total_active, y=proportion_very_active)) +
geom_point() +
geom_smooth(method = "lm",
se = FALSE,
color = "blue") +
stat_cor(aes(label=..rr.label..),
label.x=0,
label.y=0) +
labs(title="Proportion Very Active vs. Total Active Time (Highest Quintlie Removed)",
x = "Average Weekly Active Time (hours)",
y = "Proportion of Very Active Time (%)")
data <- mean_daily_intensities_wide %>%
filter(total_active > 0.25) # id != "3977333714")
plot_no_lower_quint <- ggplot(data, aes(x=total_active, y=proportion_very_active)) +
geom_point() +
geom_smooth(method = "lm",
se = FALSE,
color = "blue") +
stat_cor(aes(label=..rr.label..),
label.x=0,
label.y=0) +
labs(title="Proportion Very Active vs. Total Active Time (Lowest Quintile Removed)",
x = "Average Weekly Active Time (hours)",
y = "Proportion of Very Active Time (%)")
rm(data)
plot_all_data <- plot_all_data +
scale_x_continuous(limits=c(0,2)) +
scale_y_continuous(limits=c(0,1))
plot_no_upper_quint <- plot_no_upper_quint +
scale_x_continuous(limits=c(0,2)) +
scale_y_continuous(limits=c(0,1))
plot_no_lower_quint <- plot_no_lower_quint +
scale_x_continuous(limits=c(0,2)) +
scale_y_continuous(limits=c(0,1))
grid.arrange(plot_all_data, plot_no_upper_quint, plot_no_lower_quint, ncol = 3)
# Chunk 50: running_analysis
brisk_walk_thld <- 80
running_thld <- 110
average_movement_times_daily <- steps_src_mins_tall %>%
mutate(activity_day = as.POSIXct(format(as.Date(activity_minute)))) %>%
group_by(id, activity_day) %>%
summarize(not_walking = sum(steps == 0) / 60,
moderate_walking = sum(steps > 0 & steps <= brisk_walk_thld) / 60,
brisk_walking = sum(steps > brisk_walk_thld & steps <= running_thld) / 60,
running = sum(steps > running_thld) / 60)
average_movement_times <- average_movement_times_daily %>%
group_by(id) %>%
summarize(not_walking = mean(not_walking),
moderate_walking = mean(moderate_walking),
brisk_walking = mean(brisk_walking),
running = mean(running)) %>%
arrange(running)
speed_order = c("not_walking", "moderate_walking", "brisk_walking", "running")
average_movement_times_long <- average_movement_times %>%
tidyr::gather(key = "speed", value = "mean_hours", -id) %>%
mutate(speed = factor(speed, levels = speed_order))
average_movement_times_long$id <- factor(
average_movement_times_long$id,
levels = average_movement_times$id
)
ggplot(average_movement_times_long %>% filter(speed != "not_walking"),
aes(x = id, y = mean_hours, fill = speed)) +
geom_bar(stat = "identity") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
scale_y_continuous(breaks = seq(0,33,by=1)) +
labs(title = "Average Daily Running Speeds by User ID",
x = "User ID",
y = "Average Daily Hours")
plot_mod_walking <- plot_histo_pareto(average_movement_times$moderate_walking,
bin_width = 0.25) +
labs(title = "Average Moderate Walking Hours per Week",
x = "Average Hours per Week")
print(plot_mod_walking)
plot_brisk_walking <- plot_histo_pareto(average_movement_times$brisk_walking,
bin_width = 0.25) +
labs(title = "Average Brisk Walking Hours per Week",
x = "Average Hours per Week")
print(plot_brisk_walking)
plot_running <- plot_histo_pareto(average_movement_times$running,
bin_width = 0.25) +
labs(title = "Average Running Hours per Week",
x = "Average Hours per Week")
print(plot_running)
# Chunk 51: active_walking_over_time
p_mod_walking_vs_time <- get_time_coefficients_plot(average_movement_times_daily$id,
average_movement_times_daily$activity_day,
average_movement_times_daily$moderate_walking) +
labs(title = "Moderate Walking Over Time")
p_brisk_walking_vs_time <- get_time_coefficients_plot(average_movement_times_daily$id,
average_movement_times_daily$activity_day,
average_movement_times_daily$brisk_walking) +
labs(title = "Brisk Walking Over Time")
p_running_vs_time <- get_time_coefficients_plot(average_movement_times_daily$id,
average_movement_times_daily$activity_day,
average_movement_times_daily$running) +
labs(title = "Running Over Time")
grid.arrange(p_mod_walking_vs_time, p_brisk_walking_vs_time, p_running_vs_time, ncol = 3)
# Chunk 52: average_daily_step_counts
average_daily_steps <- steps_sum_days_tall %>%
group_by(id) %>%
summarize(average_steps = mean(steps_total))
plot_steps <- plot_histo_pareto(average_daily_steps$average_steps, 2000) +
labs(title = "Average Daily Steps by User",
x = "Average Daily Steps")
print(plot_steps)
# Chunk 53: coefficient_with_time
p_steps_time_coeffs <- get_time_coefficients_plot(steps_sum_days_tall$id,
steps_sum_days_tall$activity_day,
steps_sum_days_tall$steps_total) +
labs(title = "Correlation between Step Counts and Time")
print(p_steps_time_coeffs)
# Chunk 54: distance_vs_intensity
distance_vs_active <- activity_sum_days_wide %>%
select(id,
activity_day,
distance_moderately_active,
distance_very_active,
minutes_fairly_active,
minutes_very_active) %>%
mutate(distance_active = distance_moderately_active + distance_very_active,
minutes_active = minutes_fairly_active + minutes_very_active) %>%
group_by(id) %>%
summarize(mean_distance_active = mean(distance_active),
mean_minutes_active = mean(minutes_active))
scatter_with_LOBF(distance_vs_active$mean_minutes_active,
distance_vs_active$mean_distance_active,
c("Mean Daily Active Minutes", "Mean Daily Active Distance")) +
labs(caption = "\"Active\" refers to time spent either Fairly or Very Active") +
scale_y_continuous(breaks = seq(0,10,by=1))
heart_rate_minutes <- activity_sum_days_wide %>%
select(id,
minutes_sedentary,
minutes_lightly_active,
minutes_fairly_active,
minutes_very_active) %>%
mutate(total_hours = (minutes_sedentary +
minutes_lightly_active +
minutes_fairly_active +
minutes_very_active) / 60) %>%
group_by(id) %>%
summarize(mean_total_hours = mean(total_hours))
plot_histo_pareto(heart_rate_minutes$mean_total_hours, bin_width = 1)
View(intensity_src_mins_tall)
View(intensity_sum_hours_wide)
22099/33
670/30
count_of_activity_hours <- intensity_sum_hours_wide %>%
group_by(id) %>%
summarize(count = sum(average_intensity > -1))
View(count_of_activity_hours)
count_of_activity_hours <- intensity_sum_hours_wide %>%
group_by(id) %>%
summarize(days_logged = sum(average_intensity > -1) / 24)
View(count_of_activity_hours)
count_of_activity_hours <- intensity_sum_hours_wide %>%
group_by(id) %>%
summarize(days_logged = sum(activity_hour > 20 | activity_hour < 6))
View(count_of_activity_hours)
sleep_stt_hour <- 20 # 8pm
sleep_end_hour <- 6  # 6am
total_nights <- 30
total_sleep_hours <- total_nights * (24 - sleep_stt_hour + sleep_end_hour)
count_of_activity_hours <- intensity_sum_hours_wide %>%
group_by(id) %>%
summarize(night_hours_logged = sum(activity_hour > sleep_stt_hour | activity_hour < sleep_end_hour),
pct_night_hours_logged = night_hours_logged / total_sleep_hours)
View(count_of_activity_hours)
?hour
sleep_stt_hour <- 20 # 8pm
sleep_end_hour <- 6  # 6am
total_nights <- 30
total_sleep_hours <- total_nights * (24 - sleep_stt_hour + sleep_end_hour)
count_of_activity_hours <- intensity_sum_hours_wide %>%
mutate(raw_hour = hour(activity_hour))
group_by(id) %>%
summarize(night_hours_logged = sum(raw_hour > sleep_stt_hour | raw_hour < sleep_end_hour),
pct_night_hours_logged = night_hours_logged / total_sleep_hours)
sleep_stt_hour <- 20 # 8pm
sleep_end_hour <- 6  # 6am
total_nights <- 30
total_sleep_hours <- total_nights * (24 - sleep_stt_hour + sleep_end_hour)
count_of_activity_hours <- intensity_sum_hours_wide %>%
mutate(raw_hour = hour(activity_hour)) %>%
group_by(id) %>%
summarize(night_hours_logged = sum(raw_hour > sleep_stt_hour | raw_hour < sleep_end_hour),
pct_night_hours_logged = night_hours_logged / total_sleep_hours)
View(count_of_activity_hours)
sleep_stt_hour <- 20 # 8pm
sleep_end_hour <- 6  # 6am
total_nights <- 30
total_sleep_hours <- total_nights * (24 - sleep_stt_hour + sleep_end_hour)
sleep_hours <- intensity_sum_hours_wide %>%
mutate(raw_hour = hour(activity_hour)) %>%
group_by(id) %>%
summarize(night_hours_logged = sum(raw_hour > sleep_stt_hour | raw_hour < sleep_end_hour),
pct_night_hours_logged = night_hours_logged / total_sleep_hours)
View(count_of_activity_hours)
plot_histo_pareto(sleep_hours$pct_night_hours_logged, bin_width = 0.1)
sleep_hours <- intensity_sum_hours_wide %>%
mutate(raw_hour = hour(activity_hour))
View(count_of_activity_hours)
View(sleep_hours)
View(intensity_sum_hours_wide)
sleep_stt_hour <- 22 # 8pm
sleep_end_hour <- 4  # 6am
total_nights <- 30
total_sleep_hours <- total_nights * (24 - sleep_stt_hour + sleep_end_hour)
sleep_hours <- intensity_sum_hours_wide %>%
mutate(raw_hour = hour(activity_hour)) %>%
group_by(id) %>%
summarize(night_hours_logged = sum(raw_hour > sleep_stt_hour | raw_hour < sleep_end_hour),
pct_night_hours_logged = night_hours_logged / total_sleep_hours)
# View(sleep_hours)
plot_histo_pareto(sleep_hours$pct_night_hours_logged, bin_width = 0.1)
1/33
19/33
heartrate_polling_variance <- heartrate_src_seconds_tall %>%
mutate(polling_diff = difftime(heart_rate_second, lag(heart_rate_second), units = "secs"))
plot_histo_pareto(heartrate_polling_variance$polling_diff, bin_width = 15)
View(heartrate_polling_variance)
